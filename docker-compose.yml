version: "3.9"

services:
  server:
    build: .
    container_name: semantic-autocomplete-server
    restart: always
    ports:
      - "${PORT:-3000}:3000"
    env_file:
      - .env
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - EMBEDDING_SERVICE_URL=${EMBEDDING_SERVICE_URL:-http://embedding:5000}
    depends_on:
      redis:
        condition: service_healthy
      embedding:
        condition: service_healthy
    volumes:
      - ./vectors.json:/app/vectors.json:ro
      - ./phrases.json:/app/phrases.json:ro
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  embedding:
    build:
      context: .
      dockerfile: Dockerfile.embedding
    container_name: semantic-embedding-service
    restart: always
    env_file:
      - .env
    environment:
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-jhgan/ko-sroberta-multitask}
      - EMBEDDING_PORT=5000
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:5000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  redis:
    image: redis:7-alpine
    container_name: semantic-redis
    restart: always
    command: >
      sh -c "redis-server 
      ${REDIS_PASSWORD:+--requirepass $REDIS_PASSWORD}
      ${REDIS_MAXMEMORY:+--maxmemory $REDIS_MAXMEMORY}
      ${REDIS_MAXMEMORY:+--maxmemory-policy allkeys-lru}"
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    ports:
      - "${REDIS_PORT:-0.0.0.0}:6379:6379"
    volumes:
      - redisdata:/data
    healthcheck:
      test: ["CMD", "sh", "-c", "redis-cli ${REDIS_PASSWORD:+-a $REDIS_PASSWORD} ping | grep PONG"]
      interval: 10s
      timeout: 3s
      retries: 5

volumes:
  redisdata:
